<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MATOTA Online Eğitim</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite' }
                }
            }
        }
    </script>

    <style>
        /* --- KÖKLÜ İSKELET ÇÖZÜMÜ --- */
        html, body {
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100dvh;
            overflow: hidden; 
            background: #0f172a;
            color: white;
            margin: 0;
            padding: 0;
        }

        /* --- ÖZEL İMLEÇ (CURSOR) VE TIKLAMA EFEKTİ --- */
        body * {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="%233b82f6" stroke="rgba(255,255,255,0.8)" stroke-width="2"/></svg>') 12 12, auto;
        }
        button, a, input, [onclick], .video-card, .cursor-pointer {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="%2310b981" stroke="rgba(255,255,255,0.8)" stroke-width="2"/></svg>') 12 12, pointer !important;
        }

        .click-ripple {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            width: 20px;
            height: 20px;
            background: rgba(59, 130, 246, 0.6);
            transform: translate(-50%, -50%) scale(1);
            animation: ripple-anim 0.5s ease-out forwards;
            z-index: 99999;
        }
        @keyframes ripple-anim {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- KUSURSUZ YERLEŞİM MİMARİSİ --- */
        #video-area {
            flex: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
            gap: 16px;
            padding: 16px;
            padding-bottom: 100px; 
            overflow: hidden;
        }

        /* SAHNE (Sadece Sunum/Konuşmacı Modunda Görünür) */
        #stage-wrapper {
            flex: 1; 
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            border: 2px solid #3b82f6;
            display: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #stage-wrapper .video-card {
            width: 100%;
            height: 100%;
            border-radius: 0;
            box-shadow: none;
            max-height: none;
        }

        #stage-wrapper .video-card video {
            object-fit: contain !important; /* Sahnedeki video EKRAN TAM SIĞAR KESİLMEZ */
        }

        /* GALERİ / YAN ŞERİT (Kameralar Buradadır) */
        #gallery-wrapper {
            height: 100%;
            overflow-y: auto; 
            overflow-x: hidden;
            scrollbar-width: thin;
            transition: all 0.3s ease;
        }

        /* YENİLENMİŞ KUSURSUZ IZGARA (GRID) MODU */
        #video-area.mode-grid #gallery-wrapper {
            flex: 1; /* Tüm ekranı kapla */
            display: flex;
            flex-wrap: wrap;
            align-content: center;
            justify-content: center;
            gap: 16px;
        }

        #video-area.mode-grid .video-card {
            flex: 1 1 320px; /* Orantılı büyüme sağlar */
            max-width: 600px; /* Çok aşırı büyümesini engeller */
            height: auto;
            aspect-ratio: 16 / 9; /* Sünmeyi fiziksel olarak imkansız kılar */
        }

        /* KONUŞMACI / SUNUM MODU */
        #video-area.mode-speaker #stage-wrapper {
            display: block; 
        }

        #video-area.mode-speaker #gallery-wrapper {
            width: 260px; /* Galeriyi sağda ince bir şeride hapset */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        #video-area.mode-speaker #gallery-wrapper .video-card {
            width: 100%;
            height: 146px !important; /* Kesin yükseklik, asla sünmez */
            flex-shrink: 0;
            aspect-ratio: 16 / 9;
        }

        /* MOBİL UYUMU */
        @media (max-width: 768px) {
            #video-area {
                flex-direction: column;
                padding-bottom: 90px;
            }
            #video-area.mode-speaker #stage-wrapper {
                flex: 1;
                min-height: 40vh;
            }
            #video-area.mode-speaker #gallery-wrapper {
                width: 100%;
                height: 130px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                padding-bottom: 8px;
            }
            #video-area.mode-speaker #gallery-wrapper .video-card {
                width: 180px;
                height: 100px !important;
            }
            #video-area.mode-grid .video-card {
                max-width: 100%;
            }
        }

        /* --- KUTU İÇİ STİLLER --- */
        .video-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #1e293b;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer; /* Tıklanabilir hissi verir */
        }

        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }
        
        .mirror-mode { transform: scaleX(-1); }

        /* KAMERA KAPALI LOGOSU */
        .cam-placeholder {
            position: absolute;
            inset: 0;
            background-color: #111827;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2; 
            display: none; 
        }

        .cam-placeholder img {
            max-width: 60px; 
            max-height: 60px;
            object-fit: contain;
            opacity: 0.8;
            margin-bottom: 6px;
        }

        .video-card.cam-off .cam-placeholder { display: flex; }
        .video-card.is-screen-share .cam-placeholder,
        .video-card.is-timer .cam-placeholder { display: none !important; }
        
        /* --- KUSURSUZ YAN PANELLER --- */
        .side-panel {
            position: absolute;
            top: 56px; 
            bottom: 0;
            right: 0;
            height: calc(100dvh - 56px);
            z-index: 150;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        .side-panel.open {
            transform: translateX(0); 
        }

        /* --- YÜZEN KONTROL PANELİ --- */
        #floating-controls {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px; 
            padding: 8px 16px;
            display: flex;
            gap: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            #floating-controls {
                width: 90%;
                justify-content: space-between;
                bottom: env(safe-area-inset-bottom, 20px);
                border-radius: 20px;
                padding: 10px;
            }
        }

        .btn-active { @apply bg-gray-700 hover:bg-gray-600 text-white; }
        .btn-inactive { @apply bg-red-600 hover:bg-red-700 text-white border-red-600; }
        .btn-loading { opacity: 0.7; cursor: not-allowed; pointer-events: none; }
        .chat-msg { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col">

    <div id="loader" class="fixed inset-0 z-[60] bg-gray-900 flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-400 text-sm">MATOTA Hazırlanıyor...</p>
        </div>
    </div>

    <!-- 1. LOBİ EKRANI -->
    <div id="lobby-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-[#0f172a] hidden">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-600 to-indigo-600 shadow-lg shadow-indigo-500/30 mb-4 animate-float">
                <i class="fas fa-graduation-cap text-2xl text-white"></i>
            </div>
            <h1 id="app-title-display" class="text-3xl md:text-4xl font-bold tracking-tight text-white"></h1>
            <p id="welcome-msg-display" class="text-gray-400 mt-2 text-xs md:text-sm max-w-md mx-auto leading-relaxed"></p>
        </div>

        <div class="glass-panel w-full max-w-4xl rounded-3xl p-2 flex flex-col md:flex-row shadow-2xl overflow-hidden">
            <div class="w-full md:w-1/2 bg-black/40 rounded-2xl overflow-hidden relative aspect-video group flex justify-center items-center">
                <video id="local-preview" autoplay muted playsinline class="w-full h-full object-cover mirror-mode"></video>
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-3 p-2 bg-black/60 backdrop-blur rounded-2xl border border-white/10 z-20">
                    <button id="prev-mic-btn" class="w-10 h-10 rounded-xl bg-gray-700 hover:bg-gray-600 text-white transition flex items-center justify-center"><i class="fas fa-microphone"></i></button>
                    <button id="prev-cam-btn" class="w-10 h-10 rounded-xl bg-gray-700 hover:bg-gray-600 text-white transition flex items-center justify-center"><i class="fas fa-video"></i></button>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-6 flex flex-col justify-center gap-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider ml-1">Kullanıcı Adı</label>
                    <input type="text" id="nickname-input" class="w-full mt-1 bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider ml-1">Oda Kodu</label>
                    <input type="text" id="room-input" placeholder="ör: matematik" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-purple-500 focus:outline-none transition font-mono text-sm">
                    <p id="room-hint" class="text-[10px] text-gray-500 mt-1 ml-1">* Oda kodu otomatik küçük harfe çevrilir.</p>
                </div>
                <div id="button-group" class="grid grid-cols-2 gap-3 mt-2">
                    <button id="create-btn" class="group relative px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-semibold transition overflow-hidden">
                        <span id="btn-create-text" class="relative flex items-center justify-center gap-2 text-sm"><i class="fas fa-chalkboard-teacher"></i> Kur (Hoca)</span>
                    </button>
                    <button id="join-btn" class="px-4 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl text-white font-semibold transition">
                        <span id="btn-join-text" class="flex items-center justify-center gap-2 text-sm"><i class="fas fa-user-graduate"></i> Katıl (Öğrenci)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ODA EKRANI -->
    <div id="room-screen" class="hidden flex-1 w-full flex flex-col relative bg-[#0b1120] overflow-hidden">
        
        <header class="h-14 glass-panel border-b border-white/5 flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-video text-xs"></i>
                </div>
                <div>
                    <h2 id="room-title" class="font-bold text-white text-sm leading-tight">MATOTA</h2>
                    <div class="flex items-center gap-1.5 text-[10px] text-gray-400">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> 
                        <span id="conn-status">Bağlantı Kuruluyor...</span>
                        <span id="meeting-timer" class="hidden ml-2 font-mono text-blue-400 font-bold border-l border-white/10 pl-2">00:00:00</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="btn-toggle-layout" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 border border-white/10 transition flex items-center gap-2" title="Görünümü Değiştir">
                    <i class="fas fa-th-large"></i> <span class="hidden sm:inline">Görünüm</span>
                </button>
                <button onclick="toggleChat()" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 border border-white/10 transition flex items-center gap-2 relative">
                    <i class="fas fa-comment-alt"></i>
                    <span class="hidden sm:inline">Sohbet</span>
                    <span id="chat-notification" class="hidden bg-red-500 border-2 border-[#0f172a] w-3 h-3 rounded-full absolute -top-1 -right-1"></span>
                </button>
                <button onclick="toggleParticipants()" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 border border-white/10 transition flex items-center gap-2 relative">
                    <i class="fas fa-users"></i> 
                    <span class="hidden sm:inline">Kişiler</span>
                    <span id="participant-count" class="bg-blue-500 text-white text-[8px] rounded-full px-1.5 py-0.5 absolute -top-1 -right-1">1</span>
                </button>
                <button onclick="copyLink()" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 border border-white/10 transition flex items-center gap-2 hidden sm:flex">
                    <i class="fas fa-link"></i> <span class="hidden sm:inline">Link</span>
                </button>
            </div>
        </header>

        <!-- KUSURSUZ VİDEO ALANI MİMARİSİ -->
        <main id="video-area" class="mode-speaker">
            <div id="stage-wrapper">
                <!-- Sahnedeki Video Buraya -->
            </div>
            
            <div id="gallery-wrapper">
                <!-- Diğer Kameralar Buraya -->
            </div>
        </main>

        <!-- YAN PANELLER -->
        <div id="participants-sidebar" class="side-panel w-64 p-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2 shrink-0">
                <h3 class="font-bold text-sm">Katılımcılar</h3>
                <button onclick="toggleParticipants()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="participants-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>

        <div id="chat-sidebar" class="side-panel w-72 md:w-80 p-4 shadow-2xl">
            <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2 shrink-0">
                <h3 class="font-bold text-sm"><i class="fas fa-comments text-blue-400 mr-1"></i> Ders Sohbeti</h3>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 mb-3 pr-2 flex flex-col">
                <div class="text-xs text-center text-gray-500 my-2">Sohbete hoş geldiniz. Mesajlar kayıt altına alınmaz.</div>
            </div>
            <div class="flex gap-2 shrink-0">
                <input type="text" id="chat-input" placeholder="Mesajınız..." class="flex-1 bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                <button id="btn-send-chat" class="bg-blue-600 hover:bg-blue-500 text-white rounded-xl px-4 py-2 transition"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- YÜZEN KONTROL PANELİ -->
        <div id="floating-controls">
            <button id="toggle-mic" class="w-12 h-12 rounded-full btn-active transition flex items-center justify-center text-lg" title="Mikrofon"><i class="fas fa-microphone"></i></button>
            <button id="toggle-cam" class="w-12 h-12 rounded-full btn-active transition flex items-center justify-center text-lg" title="Kamera"><i class="fas fa-video"></i></button>
            <div class="w-px h-8 bg-gray-600 mx-1 self-center"></div>
            <button id="share-screen" class="w-12 h-12 rounded-full bg-gray-700 hover:bg-blue-600 text-white transition flex items-center justify-center text-lg" title="Ekran Paylaş"><i class="fas fa-desktop"></i></button>
            <button id="btn-utilities" onclick="els.utilsModal.classList.remove('hidden')" class="hidden w-12 h-12 rounded-full bg-gray-700 hover:bg-purple-600 text-white transition flex items-center justify-center text-lg" title="Yönetici Araçları"><i class="fas fa-toolbox"></i></button>
            <div class="w-px h-8 bg-gray-600 mx-1 self-center"></div>
            <button id="leave-btn" class="w-14 h-12 rounded-full bg-red-600 hover:bg-red-700 text-white transition flex items-center justify-center text-xl shadow-lg shadow-red-900/20" title="Ayrıl"><i class="fas fa-phone-slash"></i></button>
        </div>

        <!-- ARAÇLAR MODAL -->
        <div id="utils-modal" class="hidden fixed inset-0 z-[200] bg-black/70 flex items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-gray-800 border border-white/10 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative">
                <button onclick="els.utilsModal.classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times text-lg"></i></button>
                <h3 class="text-lg font-bold mb-5 flex items-center gap-2 border-b border-white/10 pb-3"><i class="fas fa-toolbox text-purple-400"></i> Yönetici Araçları</h3>

                <div class="mb-6 bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                    <h4 class="text-xs text-gray-400 font-bold mb-2 uppercase flex justify-between">
                        <span><i class="fas fa-record-vinyl mr-1 text-red-500"></i> Ders Kaydı</span>
                        <span id="record-status" class="hidden text-red-500 animate-pulse">Kaydediliyor</span>
                    </h4>
                    <button id="btn-record-toggle" class="w-full bg-gray-700 hover:bg-gray-600 border border-gray-600 text-white rounded-lg py-2 text-sm flex items-center justify-center gap-2 transition">
                        <i class="fas fa-play text-xs"></i> Kaydı Başlat
                    </button>
                    <p class="text-[10px] text-gray-500 mt-2">Dersi bilgisayarınıza WebM formatında kaydeder.</p>
                </div>

                <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                    <h4 class="text-xs text-gray-400 font-bold mb-2 uppercase"><i class="fas fa-hourglass-half mr-1 text-yellow-500"></i> Zamanlayıcı</h4>
                    <div class="flex gap-2 mb-3">
                        <div class="flex-1 relative">
                            <input type="number" id="timer-minutes" value="5" min="1" class="w-full bg-gray-800 border border-gray-600 rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                            <span class="absolute right-3 top-2 text-xs text-gray-400">Dk</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-timer-start" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg py-2 text-sm transition font-medium">Başlat</button>
                        <button id="btn-timer-pause" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg py-2 text-sm transition font-medium hidden">Beklet</button>
                        <button id="btn-timer-stop" class="flex-1 bg-red-600 hover:bg-red-500 text-white rounded-lg py-2 text-sm transition font-medium hidden">Kapat</button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Odaya süre sayan katılımcı kamerası ekler.</p>
                </div>
            </div>
        </div>
        
        <canvas id="timer-canvas" width="640" height="360" class="hidden"></canvas>
    </div>

    <script>
        // --- SAĞ TIK YASAĞI ---
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- TIKLAMA ANİMASYONU ---
        document.addEventListener('click', function(e) {
            const ripple = document.createElement('div');
            ripple.className = 'click-ripple';
            ripple.style.left = e.clientX + 'px';
            ripple.style.top = e.clientY + 'px';
            document.body.appendChild(ripple);
            setTimeout(() => { ripple.remove(); }, 500);
        });

        // CONFIG
        let config = {
            appTitle: "MATOTA Online Eğitim",
            teacherName: "Mustafa Kemal",
            defaultRoom: "Matematik",
            theme: { backgroundGradient: "radial-gradient(at 50% 0%, #1e1b4b 0, #0f172a 70%)" },
            messages: { 
                welcome: "Merhabalar! Premium Eğitim Platformu MATOTA'da Derse Hoş Geldiniz.", 
                teacherLabel: "Eğitmen", 
                studentLabel: "Öğrenci" 
            }
        };

        const state = { 
            localStream: null, 
            screenStream: null,
            screenCalls: [], 
            peer: null, 
            activeCalls: {},
            dataConnections: {}, 
            roomName: '',
            nickname: '',
            isTeacher: false,
            isMicOn: true,
            isCamOn: true,
            participants: [],
            timerInterval: null,
            startTime: null,
            
            isChatOpen: false,
            isParticipantsOpen: false,
            isRecording: false,
            mediaRecorder: null,
            recordingStream: null,
            recordedChunks: [],
            
            toolTimerStream: null,
            toolTimerInterval: null,
            toolTimerSeconds: 0,
            toolTimerPaused: false,
            toolTimerCalls: [],

            layoutMode: 'speaker', // Varsayılan Konuşmacı Modu
            mainSpeakerId: null 
        };

        const els = {
            loader: document.getElementById('loader'),
            lobby: document.getElementById('lobby-screen'),
            room: document.getElementById('room-screen'),
            
            videoArea: document.getElementById('video-area'),
            stageWrapper: document.getElementById('stage-wrapper'),
            galleryWrapper: document.getElementById('gallery-wrapper'),
            
            localPreview: document.getElementById('local-preview'),
            nickInput: document.getElementById('nickname-input'),
            roomInput: document.getElementById('room-input'),
            roomHint: document.getElementById('room-hint'),
            appTitle: document.getElementById('app-title-display'),
            welcomeMsg: document.getElementById('welcome-msg-display'),
            btnGroup: document.getElementById('button-group'),
            btnCreate: document.getElementById('create-btn'),
            btnJoin: document.getElementById('join-btn'),
            btnCreateText: document.getElementById('btn-create-text'),
            btnJoinText: document.getElementById('btn-join-text'),
            
            btnMic: document.getElementById('toggle-mic'),
            btnCam: document.getElementById('toggle-cam'),
            prevMic: document.getElementById('prev-mic-btn'),
            prevCam: document.getElementById('prev-cam-btn'),
            btnScreen: document.getElementById('share-screen'),
            btnLeave: document.getElementById('leave-btn'),
            
            btnToggleLayout: document.getElementById('btn-toggle-layout'),

            roomTitle: document.getElementById('room-title'),
            status: document.getElementById('conn-status'),
            timer: document.getElementById('meeting-timer'),
            sidebar: document.getElementById('participants-sidebar'),
            pList: document.getElementById('participants-list'),
            pCount: document.getElementById('participant-count'),
            
            btnUtils: document.getElementById('btn-utilities'),
            utilsModal: document.getElementById('utils-modal'),
            chatSidebar: document.getElementById('chat-sidebar'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            btnSendChat: document.getElementById('btn-send-chat'),
            chatNotif: document.getElementById('chat-notification'),
            
            btnRecordToggle: document.getElementById('btn-record-toggle'),
            recordStatus: document.getElementById('record-status'),
            
            timerMinInput: document.getElementById('timer-minutes'),
            btnTStart: document.getElementById('btn-timer-start'),
            btnTPause: document.getElementById('btn-timer-pause'),
            btnTStop: document.getElementById('btn-timer-stop'),
            timerCanvas: document.getElementById('timer-canvas')
        };

        // --- WEB AUDIO API (KESİNTİSİZ SES MOTORU) ---
        let audioCtx = null;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            try {
                if (!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                const now = audioCtx.currentTime;
                
                if (type === 'join') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.exponentialRampToValueAtTime(660, now + 0.1);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.1, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'leave') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(660, now);
                    osc.frequency.exponentialRampToValueAtTime(440, now + 0.2);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.1, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'chat') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.1, now + 0.02);
                    gain.gain.linearRampToValueAtTime(0, now + 0.15);
                    osc.start(now);
                    osc.stop(now + 0.15);
                }
            } catch (e) { console.error("Ses çalamadı", e); }
        }

        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                if (response.ok) {
                    const jsonConfig = await response.json();
                    config = { ...config, ...jsonConfig };
                }
            } catch (e) {}
            
            document.title = config.appTitle;
            els.appTitle.innerText = config.appTitle;
            els.welcomeMsg.innerText = config.messages.welcome;
            els.nickInput.placeholder = `Örn: ${config.teacherName}`;
            
            // --- ENTEGRASYON: URL PARAMETRELERİNİ OKUMA ---
            const params = new URLSearchParams(window.location.search);
            const roomParam = params.get('room');
            const nameParam = params.get('name');
            const roleParam = params.get('role'); // 'teacher' veya 'student'
            
            // 1. ODA KODU AYARI
            if (roomParam) {
                els.roomInput.value = roomParam;
                els.roomInput.setAttribute('disabled', 'true');
                els.roomInput.classList.add('bg-gray-800', 'text-gray-400', 'cursor-not-allowed');
            } else {
                els.roomInput.value = config.defaultRoom;
            }

            // 2. İSİM AYARI
            if (nameParam) {
                els.nickInput.value = nameParam;
                els.nickInput.setAttribute('disabled', 'true');
                els.nickInput.classList.add('bg-gray-800', 'text-gray-400', 'cursor-not-allowed');
            }

            // 3. ROL AYARI (BUTONLARI GİZLE/GÖSTER)
            if (roleParam === 'teacher') {
                els.btnJoin.style.display = 'none'; // Öğrenci butonunu gizle
                els.btnGroup.classList.remove('grid-cols-2');
                els.btnGroup.classList.add('grid-cols-1');
                els.roomHint.innerHTML = '<span class="text-blue-400 flex items-center gap-1"><i class="fas fa-chalkboard-teacher"></i> Öğretmen yetkisi algılandı.</span>';
                if(!nameParam) setTimeout(() => els.nickInput.focus(), 500);
            } else if (roleParam === 'student' || roomParam) {
                els.btnCreate.style.display = 'none'; // Hoca butonunu gizle
                els.btnGroup.classList.remove('grid-cols-2');
                els.btnGroup.classList.add('grid-cols-1');
                els.roomHint.innerHTML = '<span class="text-green-400 flex items-center gap-1"><i class="fas fa-user-graduate"></i> Öğrenci olarak katılım sağlanıyor.</span>';
                if(!nameParam) setTimeout(() => els.nickInput.focus(), 500);
            }

            if(config.theme.backgroundGradient) document.body.style.backgroundImage = config.theme.backgroundGradient;
            els.loader.style.display = 'none';
            els.lobby.classList.remove('hidden');
        }

        async function getMediaStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                state.localStream = stream;
                els.localPreview.srcObject = stream;
                els.localPreview.muted = true;
                updateButtonUI(els.btnMic, true, 'fa-microphone', 'fa-microphone-slash');
                updateButtonUI(els.btnCam, true, 'fa-video', 'fa-video-slash');
                return true;
            } catch (err) { return false; }
        }

        function updateButtonUI(btn, isActive, iconOn, iconOff) {
            const i = btn.querySelector('i');
            if (isActive) {
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'border-red-600');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                if(i) i.className = `fas ${iconOn}`;
            } else {
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                btn.classList.add('bg-red-600', 'hover:bg-red-700', 'border-red-600');
                if(i) i.className = `fas ${iconOff}`;
            }
        }

        els.roomInput.addEventListener('input', (e) => {
            let val = e.target.value.toLowerCase();
            val = val.replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's').replace(/ö/g, 'o').replace(/ç/g, 'c');
            e.target.value = val.replace(/[^a-z0-9]/g, '');
        });

        function startTimer() {
            state.startTime = Date.now();
            state.timerInterval = setInterval(() => {
                const diff = Date.now() - state.startTime;
                const date = new Date(diff);
                const hh = String(Math.floor(diff / 3600000)).padStart(2, '0');
                const mm = String(date.getUTCMinutes()).padStart(2, '0');
                const ss = String(date.getUTCSeconds()).padStart(2, '0');
                els.timer.innerText = `${hh}:${mm}:${ss}`;
            }, 1000);
        }

        async function startSession(asTeacher) {
            initAudio(); 
            
            const btn = asTeacher ? els.btnCreate : els.btnJoin;
            const btnText = asTeacher ? els.btnCreateText : els.btnJoinText;
            const originalText = btnText.innerHTML;
            btn.classList.add('btn-loading');
            btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';

            let roomVal = els.roomInput.value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const nickVal = els.nickInput.value.trim() || (asTeacher ? config.teacherName : "Misafir");

            if (!roomVal) { alert("Kod yanlış lütfen doğru kodu giriniz."); resetButton(btn, btnText, originalText); return; }
            if (!state.localStream) {
                const hasPermission = await getMediaStream();
                if (!hasPermission) { alert("Kamera izni gerekli."); resetButton(btn, btnText, originalText); return; }
            }

            state.roomName = roomVal;
            state.nickname = nickVal;
            state.isTeacher = asTeacher;
            
            els.lobby.classList.add('hidden');
            els.room.classList.remove('hidden');
            els.roomTitle.innerText = `MATOTA / ${roomVal}`;

            if (asTeacher) {
                els.timer.classList.remove('hidden');
                els.btnUtils.classList.remove('hidden');
                startTimer();
            }

            updateParticipantsList('me', nickVal, asTeacher);
            addVideo(state.localStream, `${nickVal} (Sen)`, true, 'me', false);

            const prefix = config.teacherName.replace(/\s+/g, '').toUpperCase();
            let myId = asTeacher 
                ? `${prefix}_${roomVal}_HOST` 
                : `${prefix}_${roomVal}_GUEST_${Math.random().toString(36).substr(2, 6)}`;

            state.peer = new Peer(myId, { debug: 1 });

            state.peer.on('open', (id) => {
                els.status.innerText = asTeacher ? "Ders Başlatıldı" : "Derse Bağlanılıyor...";
                els.status.classList.add('text-green-400');
                if (!asTeacher) connectToHost(`${prefix}_${roomVal}_HOST`);
            });

            state.peer.on('connection', (conn) => {
                conn.on('open', () => { state.dataConnections[conn.peer] = conn; });
                setupDataListener(conn);
            });

            state.peer.on('call', (call) => {
                const isScreenShare = call.metadata && call.metadata.type === 'screen';
                const isTimer = call.metadata && call.metadata.type === 'timer';

                if(isScreenShare || isTimer) call.answer(); else call.answer(state.localStream);

                const guestName = asTeacher ? config.messages.studentLabel : config.messages.teacherLabel;
                call.on('stream', (remoteStream) => {
                    if (isScreenShare) {
                        addVideo(remoteStream, "Ekran Paylaşımı", false, `screen-${call.peer}`, true);
                    } else if (isTimer) {
                        addVideo(remoteStream, "Zamanlayıcı", true, `timer-${call.peer}`, false);
                    } else {
                        addVideo(remoteStream, guestName, false, call.peer, false);
                        updateParticipantsList(call.peer, guestName, false);
                    }
                });
                
                if (!isScreenShare && !isTimer) state.activeCalls[call.peer] = call;

                call.on('close', () => {
                    const removeId = isScreenShare ? `screen-${call.peer}` : (isTimer ? `timer-${call.peer}` : call.peer);
                    const fullCardId = `vid-${removeId}`;
                    
                    document.getElementById(fullCardId)?.remove();

                    if (state.mainSpeakerId === fullCardId) {
                        state.mainSpeakerId = autoSelectMainSpeaker();
                        if (!state.mainSpeakerId) state.layoutMode = 'grid';
                    }
                    applyLayout();
                    
                    if (!isScreenShare && !isTimer) removeParticipant(call.peer);
                });
            });
            
            state.peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("Bu oda kodu şu an kullanımda. Lütfen bekleyin.");
                    location.reload();
                } else if (err.type === 'peer-unavailable') {
                    alert("Ders henüz başlatılmadı. Lütfen öğretmenin girmesini bekleyin.");
                    resetUI();
                }
            });
        }

        function resetButton(btn, txtEl, originalTxt) {
            btn.classList.remove('btn-loading');
            txtEl.innerHTML = originalTxt;
        }

        function resetUI() {
            els.lobby.classList.remove('hidden');
            els.room.classList.add('hidden');
            resetButton(els.btnCreate, els.btnCreateText, '<i class="fas fa-chalkboard-teacher"></i> Kur (Hoca)');
            resetButton(els.btnJoin, els.btnJoinText, '<i class="fas fa-user-graduate"></i> Katıl (Öğrenci)');
            if(state.peer) state.peer.destroy();
            if(state.timerInterval) clearInterval(state.timerInterval);
            els.timer.classList.add('hidden');
            els.timer.innerText = "00:00:00";
            els.btnUtils.classList.add('hidden');
        }

        function connectToHost(hostId) {
            const call = state.peer.call(hostId, state.localStream);
            call.on('stream', (remoteStream) => {
                addVideo(remoteStream, config.messages.teacherLabel, false, hostId, false);
                updateParticipantsList(hostId, config.messages.teacherLabel, true);
                els.status.innerText = "Canlı Yayın";
            });
            call.on('close', () => {
                alert("Öğretmen dersi sonlandırdı. Çıkış yapılıyor...");
                location.reload();
            });
            state.activeCalls[hostId] = call;
            const conn = state.peer.connect(hostId);
            conn.on('open', () => { state.dataConnections[hostId] = conn; });
            setupDataListener(conn);
        }

        function setupDataListener(conn) {
            conn.on('data', (data) => {
                if(data.type === 'kick') { alert("Dersten çıkarıldınız."); location.reload(); }
                if(data.type === 'cam-status') togglePeerVideoPlaceholder(conn.peer, data.enabled);
                if(data.type === 'chat') {
                    appendChatMessage(data);
                    if(state.isTeacher) broadcastData(data, conn.peer);
                }
            });
        }

        function broadcastData(data, excludePeer = null) {
            Object.values(state.dataConnections).forEach(conn => { 
                if (conn.open && conn.peer !== excludePeer) conn.send(data); 
            });
        }

        // --- KUSURSUZ YAN PANEL YÖNETİMİ ---
        window.toggleChat = () => {
            state.isChatOpen = !state.isChatOpen;
            if(state.isChatOpen) {
                els.chatSidebar.classList.add('open');
                els.chatNotif.classList.add('hidden');
                setTimeout(() => els.chatInput.focus(), 300);
                
                state.isParticipantsOpen = false;
                els.sidebar.classList.remove('open');
            } else {
                els.chatSidebar.classList.remove('open');
            }
        };

        window.toggleParticipants = () => {
            state.isParticipantsOpen = !state.isParticipantsOpen;
            if(state.isParticipantsOpen) {
                els.sidebar.classList.add('open');
                
                state.isChatOpen = false;
                els.chatSidebar.classList.remove('open');
            } else {
                els.sidebar.classList.remove('open');
            }
        };

        function sendChat() {
            const text = els.chatInput.value.trim();
            if(!text) return;
            
            const msgObj = {
                type: 'chat',
                sender: state.nickname || 'Misafir',
                text: text,
                time: new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})
            };
            
            appendChatMessage(msgObj);
            
            if(state.isTeacher) {
                broadcastData(msgObj);
            } else {
                const prefix = config.teacherName.replace(/\s+/g, '').toUpperCase();
                const hostId = `${prefix}_${state.roomName}_HOST`;
                if(state.dataConnections[hostId] && state.dataConnections[hostId].open) {
                    state.dataConnections[hostId].send(msgObj);
                }
            }
            els.chatInput.value = '';
        }

        els.btnSendChat.addEventListener('click', sendChat);
        els.chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChat(); });

        function appendChatMessage(data) {
            const isMe = data.sender === state.nickname;
            const div = document.createElement('div');
            
            const senderNameColor = isMe ? 'text-blue-300' : 'text-yellow-400';
            const displayName = isMe ? 'Sen' : (data.sender || 'Bilinmeyen');
            
            div.className = `chat-msg max-w-[85%] rounded-xl p-2.5 text-sm flex flex-col ${isMe ? 'bg-blue-600 text-white self-end rounded-br-none' : 'bg-gray-800 text-gray-200 self-start rounded-bl-none border border-gray-700'}`;
            
            div.innerHTML = `
                <div class="text-[11px] ${senderNameColor} font-bold mb-1 border-b border-white/10 pb-1 flex justify-between gap-3">
                    <span>${displayName}</span>
                    <span class="font-normal text-white/70">${data.time}</span>
                </div>
                <div class="break-words text-[13px] leading-relaxed text-white chat-text-content"></div>
            `;
            div.querySelector('.chat-text-content').textContent = data.text;
            
            els.chatMessages.appendChild(div);
            els.chatMessages.scrollTop = els.chatMessages.scrollHeight;
            
            if(!state.isChatOpen && !isMe) {
                els.chatNotif.classList.remove('hidden');
                playSound('chat');
            }
        }

        // --- ZEKİ ÖNCELİK VE LAYOUT MİMARİSİ (EKRAN PAYLAŞIMI > ÖĞRETMEN > DİĞERLERİ) ---
        function autoSelectMainSpeaker() {
            // 1. Öncelik: Ekran Paylaşımı
            const screenShare = document.querySelector('.is-screen-share');
            if (screenShare) return screenShare.id;
            
            // 2. Öncelik: Öğretmen
            let teacherCard = null;
            if (state.isTeacher) {
                teacherCard = document.getElementById('vid-me');
            } else {
                const allCards = document.querySelectorAll('.video-card');
                for(let card of allCards) {
                    if (card.id.includes('HOST')) {
                        teacherCard = card;
                        break;
                    }
                }
            }
            if (teacherCard) return teacherCard.id;
            
            // 3. Öncelik: Herhangi bir öğrenci (Zamanlayıcı hariç)
            const firstVid = document.querySelector('.video-card:not(.is-timer)');
            if (firstVid) return firstVid.id;

            // 4. En son çare: Zamanlayıcı
            const timerCard = document.querySelector('.is-timer');
            if (timerCard) return timerCard.id;
            
            return null;
        }

        els.btnToggleLayout.addEventListener('click', () => {
            if (state.layoutMode === 'grid') {
                state.mainSpeakerId = autoSelectMainSpeaker();
                if (state.mainSpeakerId) {
                    state.layoutMode = 'speaker';
                }
                applyLayout();
            } else {
                state.mainSpeakerId = null;
                state.layoutMode = 'grid';
                applyLayout();
            }
        });

        function setMainSpeaker(id) {
            state.mainSpeakerId = id;
            state.layoutMode = 'speaker';
            applyLayout();
        }

        function applyLayout() {
            if (state.layoutMode === 'speaker' && state.mainSpeakerId) {
                els.videoArea.classList.remove('mode-grid');
                els.videoArea.classList.add('mode-speaker');
                
                const mainEl = document.getElementById(state.mainSpeakerId);
                if (mainEl) els.stageWrapper.appendChild(mainEl);
                
                document.querySelectorAll('.video-card').forEach(card => {
                    if (card.id !== state.mainSpeakerId) els.galleryWrapper.appendChild(card);
                });
            } else {
                els.videoArea.classList.remove('mode-speaker');
                els.videoArea.classList.add('mode-grid');
                
                document.querySelectorAll('.video-card').forEach(card => {
                    els.galleryWrapper.appendChild(card);
                });
            }

            setTimeout(() => {
                document.querySelectorAll('video').forEach(vid => {
                    if (vid.srcObject && vid.paused) vid.play().catch(()=>{});
                });
            }, 50);
        }

        function addVideo(stream, label, isMuted, id, isScreenShare) {
            const cardId = `vid-${id}`;
            if(document.getElementById(cardId)) return;
            
            const div = document.createElement('div');
            div.className = 'video-card animate-fade-in group';
            div.id = cardId;
            
            if (isScreenShare) div.classList.add('is-screen-share');
            if (id.includes('timer')) div.classList.add('is-timer');

            const placeholder = document.createElement('div');
            placeholder.className = 'cam-placeholder';
            placeholder.innerHTML = `<img src="https://r.resimlink.com/ZmxWCl-R70.png"><span class="text-gray-400 text-[10px] font-semibold tracking-wider mt-1">KAMERA KAPALI</span>`;
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if (isMuted) video.muted = true;
            if (id === 'me' && !isScreenShare) video.classList.add('mirror-mode');
            
            const tag = document.createElement('div');
            tag.className = 'absolute bottom-2 left-2 bg-black/60 backdrop-blur-md px-3 py-1 rounded-lg text-xs font-medium border border-white/10 text-white flex items-center gap-2 z-10';
            tag.innerHTML = `<i class="fas fa-${isScreenShare ? 'desktop' : (id.includes('timer') ? 'hourglass-half' : 'user')} text-[10px] ${id.includes('timer') ? 'text-yellow-400' : 'text-blue-400'}"></i> ${label}`;
            
            // Çift tıklayınca sahneye al, sahnede ise ızgaraya dön
            div.addEventListener('dblclick', () => {
                if (state.layoutMode === 'speaker' && state.mainSpeakerId === cardId) {
                    state.mainSpeakerId = null;
                    state.layoutMode = 'grid';
                    applyLayout();
                } else {
                    setMainSpeaker(cardId);
                }
            });

            div.appendChild(video);
            if (!isScreenShare && !id.includes('timer')) div.appendChild(placeholder); 
            div.appendChild(tag);
            
            els.galleryWrapper.appendChild(div);
            
            // YENİ EKLEME MANTIĞI (ÖNCELİĞE GÖRE)
            if (isScreenShare) {
                setMainSpeaker(cardId);
            } else if (!state.mainSpeakerId && state.layoutMode === 'speaker') {
                state.mainSpeakerId = autoSelectMainSpeaker();
                applyLayout();
            } else {
                applyLayout();
            }

            if (id !== 'me' && !isScreenShare && !id.includes('timer')) {
                playSound('join');
            }
        }

        // --- ARAÇLAR VE KAYIT ---
        els.btnRecordToggle.addEventListener('click', async () => {
            if (state.isRecording) {
                state.mediaRecorder.stop();
                state.isRecording = false;
                els.btnRecordToggle.innerHTML = '<i class="fas fa-play text-xs"></i> Kaydı Başlat';
                els.btnRecordToggle.className = 'w-full bg-gray-700 hover:bg-gray-600 border border-gray-600 text-white rounded-lg py-2 text-sm flex items-center justify-center gap-2 transition';
                els.recordStatus.classList.add('hidden');
                if (state.recordingStream) state.recordingStream.getTracks().forEach(t => t.stop());
                state.recordingStream = null;
            } else {
                try {
                    const recordStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    state.recordingStream = recordStream;
                    state.mediaRecorder = new MediaRecorder(recordStream, { mimeType: 'video/webm' });
                    state.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) state.recordedChunks.push(e.data); };
                    state.mediaRecorder.onstop = () => {
                        const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `MATOTA_Ders_Kaydi_${new Date().getTime()}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                        state.recordedChunks = [];
                    };
                    recordStream.getVideoTracks()[0].onended = () => { if(state.isRecording) els.btnRecordToggle.click(); };
                    state.mediaRecorder.start();
                    state.isRecording = true;
                    els.btnRecordToggle.innerHTML = '<i class="fas fa-stop text-xs"></i> Kaydı Bitir ve İndir';
                    els.btnRecordToggle.className = 'w-full bg-red-600 hover:bg-red-500 text-white rounded-lg py-2 text-sm flex items-center justify-center gap-2 transition shadow-lg shadow-red-900/50';
                    els.recordStatus.classList.remove('hidden');
                } catch (e) { alert("Kayıt başlatılamadı. Ekran izni vermelisiniz."); }
            }
        });

        els.btnScreen.addEventListener('click', async () => {
            if (state.screenStream) {
                state.screenStream.getTracks().forEach(track => track.stop());
                state.screenStream = null;
                els.btnScreen.classList.remove('bg-blue-600', 'text-white');
                els.btnScreen.classList.add('bg-gray-700');
                
                const screenId = 'vid-myscreen';
                document.getElementById(screenId)?.remove();
                
                if(state.mainSpeakerId === screenId) {
                    state.mainSpeakerId = autoSelectMainSpeaker();
                    if (!state.mainSpeakerId) state.layoutMode = 'grid';
                }
                
                state.screenCalls.forEach(call => call.close());
                state.screenCalls = [];
                applyLayout();
            } else {
                try {
                    const shareStream = await navigator.mediaDevices.getDisplayMedia({ cursor: true });
                    state.screenStream = shareStream;
                    shareStream.getVideoTracks()[0].onended = () => els.btnScreen.click();
                    els.btnScreen.classList.remove('bg-gray-700');
                    els.btnScreen.classList.add('bg-blue-600', 'text-white');
                    
                    addVideo(shareStream, "Ekran Paylaşımı (Sen)", true, 'myscreen', true);
                    
                    state.participants.forEach(p => {
                        if (p.id !== 'me') {
                            const call = state.peer.call(p.id, shareStream, { metadata: { type: 'screen' } });
                            state.screenCalls.push(call);
                        }
                    });
                } catch (err) { }
            }
        });

        function drawTimerOnCanvas(ctx, canvas, width, height) {
            ctx.fillStyle = '#1e293b'; 
            ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            if (state.toolTimerSeconds > 0) {
                const m = Math.floor(state.toolTimerSeconds / 60).toString().padStart(2, '0');
                const s = (state.toolTimerSeconds % 60).toString().padStart(2, '0');
                ctx.font = 'bold 100px "Plus Jakarta Sans", sans-serif';
                ctx.fillText(`${m}:${s}`, width / 2, height / 2 - 10);
                if (state.toolTimerPaused) {
                    ctx.font = 'bold 30px sans-serif';
                    ctx.fillStyle = '#ef4444';
                    ctx.fillText('DURAKLATILDI', width / 2, height / 2 + 70);
                } else {
                    ctx.font = '24px sans-serif';
                    ctx.fillStyle = '#94a3b8';
                    ctx.fillText('KALAN SÜRE', width / 2, height / 2 + 70);
                }
            } else {
                ctx.font = 'bold 60px sans-serif';
                ctx.fillStyle = '#22c55e';
                ctx.fillText('SÜRE BİTTİ', width / 2, height / 2);
            }
        }

        els.btnTStart.addEventListener('click', () => {
            const minutes = parseInt(els.timerMinInput.value) || 5;
            if (state.toolTimerStream && !state.toolTimerPaused) return; 
            if (state.toolTimerPaused) {
                state.toolTimerPaused = false;
                els.btnTPause.innerText = 'Beklet';
                els.btnTPause.classList.replace('bg-blue-600', 'bg-yellow-600');
                return;
            }
            state.toolTimerSeconds = minutes * 60;
            state.toolTimerPaused = false;
            const canvas = els.timerCanvas;
            const ctx = canvas.getContext('2d');
            state.toolTimerStream = canvas.captureStream(15);
            drawTimerOnCanvas(ctx, canvas, canvas.width, canvas.height);
            state.toolTimerInterval = setInterval(() => {
                if (!state.toolTimerPaused && state.toolTimerSeconds > 0) state.toolTimerSeconds--;
                drawTimerOnCanvas(ctx, canvas, canvas.width, canvas.height);
            }, 1000);
            
            addVideo(state.toolTimerStream, "Zamanlayıcı", true, 'tool-timer', false);
            
            state.participants.forEach(p => {
                if (p.id !== 'me') {
                    const call = state.peer.call(p.id, state.toolTimerStream, { metadata: { type: 'timer' } });
                    state.toolTimerCalls.push(call);
                }
            });
            els.btnTStart.classList.add('hidden');
            els.btnTPause.classList.remove('hidden');
            els.btnTStop.classList.remove('hidden');
            els.timerMinInput.disabled = true;
        });

        els.btnTPause.addEventListener('click', () => {
            state.toolTimerPaused = true;
            drawTimerOnCanvas(els.timerCanvas.getContext('2d'), els.timerCanvas, els.timerCanvas.width, els.timerCanvas.height);
            els.btnTPause.innerText = 'Devam Et';
            els.btnTPause.classList.replace('bg-yellow-600', 'bg-blue-600');
        });

        els.btnTStop.addEventListener('click', () => {
            if (state.toolTimerInterval) clearInterval(state.toolTimerInterval);
            if (state.toolTimerStream) state.toolTimerStream.getTracks().forEach(t => t.stop());
            state.toolTimerStream = null;
            state.toolTimerCalls.forEach(c => c.close());
            state.toolTimerCalls = [];
            
            const timerId = 'vid-tool-timer';
            document.getElementById(timerId)?.remove();
            
            if(state.mainSpeakerId === timerId) {
                state.mainSpeakerId = autoSelectMainSpeaker();
                if (!state.mainSpeakerId) state.layoutMode = 'grid';
            }
            applyLayout();
            
            els.btnTStart.classList.remove('hidden');
            els.btnTPause.classList.add('hidden');
            els.btnTStop.classList.add('hidden');
            els.btnTPause.innerText = 'Beklet'; 
            els.btnTPause.classList.replace('bg-blue-600', 'bg-yellow-600');
            els.timerMinInput.disabled = false;
        });

        function togglePeerVideoPlaceholder(peerId, isEnabled) {
            const container = document.getElementById(`vid-${peerId}`);
            if (container) {
                const placeholder = container.querySelector('.cam-placeholder');
                if (placeholder) {
                    if (isEnabled) placeholder.style.display = 'none';
                    else placeholder.style.display = 'flex';
                }
            }
        }

        function updateParticipantsList(id, name, isTeacherPeer) {
            if (state.participants.some(p => p.id === id)) return;
            state.participants.push({ id, name, isTeacherPeer });
            renderParticipants();
        }

        function removeParticipant(id) {
            const exists = state.participants.find(p => p.id === id);
            if (exists) {
                playSound('leave'); 
                state.participants = state.participants.filter(p => p.id !== id);
                renderParticipants();
            }
        }

        function renderParticipants() {
            els.pCount.innerText = state.participants.length;
            els.pList.innerHTML = '';
            state.participants.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/5 p-2 rounded-lg text-xs';
                const left = document.createElement('div');
                left.className = 'flex items-center gap-2';
                left.innerHTML = `<i class="fas fa-user-circle text-gray-400"></i> <span>${p.name} ${p.id === 'me' ? '(Sen)' : ''}</span>`;
                item.appendChild(left);
                if (state.isTeacher && p.id !== 'me') {
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'text-red-500 hover:text-red-400 p-1';
                    kickBtn.innerHTML = '<i class="fas fa-times"></i>';
                    kickBtn.onclick = () => kickUser(p.id);
                    item.appendChild(kickBtn);
                }
                els.pList.appendChild(item);
            });
        }

        function kickUser(peerId) {
            if(!confirm("Kullanıcı atılsın mı?")) return;
            const conn = state.dataConnections[peerId];
            if (conn && conn.open) conn.send({ type: 'kick' });
            if (state.activeCalls[peerId]) state.activeCalls[peerId].close();
            
            const pId = `vid-${peerId}`;
            document.getElementById(pId)?.remove();
            
            if(state.mainSpeakerId === pId) {
                state.mainSpeakerId = autoSelectMainSpeaker();
                if(!state.mainSpeakerId) state.layoutMode = 'grid';
            }
            applyLayout();
            removeParticipant(peerId);
        }

        function toggleAudio() {
            if (!state.localStream) return;
            const track = state.localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            state.isMicOn = track.enabled;
            updateButtonUI(els.btnMic, state.isMicOn, 'fa-microphone', 'fa-microphone-slash');
            updateButtonUI(els.prevMic, state.isMicOn, 'fa-microphone', 'fa-microphone-slash');
        }

        function toggleVideo() {
            if (!state.localStream) return;
            const track = state.localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            state.isCamOn = track.enabled;
            updateButtonUI(els.btnCam, state.isCamOn, 'fa-video', 'fa-video-slash');
            updateButtonUI(els.prevCam, state.isCamOn, 'fa-video', 'fa-video-slash');
            togglePeerVideoPlaceholder('me', state.isCamOn);
            broadcastData({ type: 'cam-status', enabled: state.isCamOn });
        }

        els.btnCreate.addEventListener('click', () => { initAudio(); startSession(true); });
        els.btnJoin.addEventListener('click', () => { initAudio(); startSession(false); });
        els.btnMic.addEventListener('click', toggleAudio);
        els.prevMic.addEventListener('click', toggleAudio);
        els.btnCam.addEventListener('click', toggleVideo);
        els.prevCam.addEventListener('click', toggleVideo);
        
        // Kopyalanan linkin sadece öğrenci linki olmasını sağladık
        window.copyLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?room=${state.roomName}&role=student`;
            navigator.clipboard.writeText(url);
            alert("Öğrenci Katılım Linki Kopyalandı!");
        };

        els.btnLeave.addEventListener('click', () => location.reload());
        window.addEventListener("beforeunload", () => { if (state.peer) state.peer.destroy(); });
        
        window.addEventListener('load', () => {
            loadConfig(); 
            getMediaStream();
        });

    </script>
</body>
</html>
