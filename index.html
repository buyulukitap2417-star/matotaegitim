-- Önce her şeyi temizleyelim (Hatalı kalıntı kalmasın)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();

-- 1. PROFILLER TABLOSU
CREATE TABLE IF NOT EXISTS public.profiles (
  id uuid REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  full_name text,
  email text,
  role text CHECK (role IN ('teacher', 'student')),
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 2. DERSLER TABLOSU
CREATE TABLE IF NOT EXISTS public.lessons (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  title text NOT NULL,
  link text NOT NULL,
  scheduled_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 3. ODEVLER TABLOSU
CREATE TABLE IF NOT EXISTS public.homeworks (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  title text NOT NULL,
  pdf_url text,
  deadline timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 4. SINAVLAR TABLOSU
CREATE TABLE IF NOT EXISTS public.exams (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  title text NOT NULL,
  duration integer NOT NULL,
  questions jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 5. SINAV SONUCLARI TABLOSU
CREATE TABLE IF NOT EXISTS public.submissions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  exam_id uuid REFERENCES public.exams(id) ON DELETE CASCADE,
  student_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  answers jsonb,
  score float,
  completed_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 6. DINAMIK ICERIK TABLOSU
CREATE TABLE IF NOT EXISTS public.dynamic_content (
  type text PRIMARY KEY,
  html_content text,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 7. OTOMATIK PROFIL OLUSTURMA FONKSIYONU
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, role, email)
  VALUES (
    new.id,
    coalesce(new.raw_user_meta_data->>'full_name', 'Yeni Kullanıcı'),
    coalesce(lower(new.raw_user_meta_data->>'role'), 'student'),
    new.email
  );
  RETURN new;
END;
$$;

-- 8. TETIKLEYICI (TRIGGER) - BOSLUKLARA DIKKAT EDEREK OLUSTURUYORUZ
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
